
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>karidyang的技术博客</title>
  <meta name="author" content="karidyang">

  
  <meta name="description" content="Docker是什么 Docker是一个容器
Docker基本命令 创建Ubuntu系统的容器 docker run -it ubuntu:14.04 /bin/bash
查看当前所有容器 docker ps -a
删除容器 docker rm {容器ID/名称}
发布容器 docker &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://karidyang.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="karidyang的技术博客" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> -->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">karidyang的技术博客</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:karidyang.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/26/learn-docker/">学习Docker</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-26T13:28:55+08:00" pubdate data-updated="true">Feb 26<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ol>
<li><p>Docker是什么
 Docker是一个容器</p></li>
<li><p>Docker基本命令</p>

<ul>
<li>创建Ubuntu系统的容器 <code>docker run -it ubuntu:14.04 /bin/bash</code></li>
<li>查看当前所有容器 <code>docker ps -a</code></li>
<li>删除容器 <code>docker rm {容器ID/名称}</code></li>
<li>发布容器 <code>docker commit</code></li>
<li>绑定随机端口 <code>docker run -d -P --name {容器名} ubuntu:14.04 /bin/bash</code></li>
<li>绑定指定端口 <code>docker run -d -p {本机ip}:{本机端口}:{容器端口} --name {容器名} ubuntu:14.04 /bin/bash</code></li>
<li>挂载本机目录 <code>docker run -d -v `pwd`:/webapp ubuntu:14.04 /bin/bash</code></li>
</ul>
</li>
<li><p>Dockerfile</p>

<p> 使用Dockerfile可以比较方便的统一完成容器的搭建、配置工作
 一个比较完整的文件示例如下
 &#8220;`
 #Version 1.0.1
 From ubuntu:14.04   #基本镜像</p>

<p> MAINTAINER xxx &ldquo;<a href="&#x6d;&#97;&#105;&#x6c;&#x74;&#111;&#x3a;&#120;&#120;&#x78;&#64;&#x78;&#120;&#120;&#x2e;&#120;&#120;">&#x78;&#120;&#120;&#64;&#x78;&#120;&#x78;&#x2e;&#120;&#120;</a>&rdquo; #镜像作者信息</p>

<p> #设置root用户为后续命令的执行者
 USER root</p>

<p> #执行操作
 RUN apt-get update
 RUN apt-get install -y nginx</p>

<p> #使用&amp;&amp;拼接命令
 RUN touch test.txt &amp;&amp; echo &lsquo;test&rsquo; >> test.txt</p>

<p> #对外暴露端口
 EXPOSE 80 8080 9000</p>

<p> #添加文件
 ADD abc.txt /opt
 #添加网络文件
 ADD <a href="http://xxx">http://xxx</a> /opt</p>

<p> #设置环境变量
 ENV WEB_PORT=80</p>

<p> #设置工作目录
 WORKDIR /opt/</p>

<p> #设置卷
 VOLUME [&ldquo;/data&rdquo;, &ldquo;/var/www&rdquo;]</p>

<p> &#8220;`</p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/22/da-jian-shi-pin-bo-fang-fu-wu/">搭建视频播放服务</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-22T17:01:46+08:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>安装必备软件</h4>

<ul>
<li>libx264
得到安装源代码 git clone git://git.videolan.org/x264.git
编译</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./configure --disable-yasm --enable-shared --enable-static
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<p>把so包增加到系统中</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo '/usr/local/lib/' &gt;&gt; /etc/ld.so.conf
</span><span class='line'>ldconfig</span></code></pre></td></tr></table></div></figure>


<ul>
<li>ffmpeg
下载 <a href="http://ffmpeg.org/releases/ffmpeg-2.7.2.tar.bz2">http://ffmpeg.org/releases/ffmpeg-2.7.2.tar.bz2</a>
编译 ./configure &mdash;disable-yasm</li>
</ul>


<h4>使用</h4>

<p>把mp4文件分割为多个ts文件和m3u8</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ffmpeg -i 2001045000007.mp4 -c:v libx264 -c:a aac -strict -2 -f hls -hls_time 15 -hls_list_size 0 output.m3u8</span></code></pre></td></tr></table></div></figure>


<p>-hls_time n: 设置每片的长度，默认值为2。单位为秒</p>

<p>-hls_list_size n:设置播放列表保存的最多条目，设置为0会保存有所片信息，默认值为5</p>

<p>-hls_wrap n:设置多少片之后开始覆盖，如果设置为0则不会覆盖，默认值为0.这个选项能够避免在磁盘上存储过多的片，而且能够限制写入磁盘的最多的片的数量</p>

<p>-hls_start_number n:设置播放列表中sequence number的值为number，默认值为0</p>

<p>注意：播放列表的sequence number 对每个segment来说都必须是唯一的，而且它不能和片的文件名（当使用wrap选项时，文件名有可能会重复使用）混淆</p>

<p>生成的m3u8文件内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat output.m3u8
</span><span class='line'>#EXTM3U
</span><span class='line'>#EXT-X-VERSION:3
</span><span class='line'>#EXT-X-TARGETDURATION:22
</span><span class='line'>#EXT-X-MEDIA-SEQUENCE:0
</span><span class='line'>#EXTINF:21.050000,
</span><span class='line'>output0.ts
</span><span class='line'>#EXTINF:11.000000,
</span><span class='line'>output1.ts
</span><span class='line'>#EXTINF:13.500000,
</span><span class='line'>output2.ts
</span><span class='line'>#EXTINF:14.500000,
</span><span class='line'>output3.ts
</span><span class='line'>#EXTINF:16.500000,
</span><span class='line'>output4.ts
</span><span class='line'>#EXTINF:19.600000,
</span><span class='line'>output5.ts
</span><span class='line'>#EXTINF:8.900000,
</span><span class='line'>output6.ts
</span><span class='line'>#EXTINF:14.950000,
</span><span class='line'>output7.ts
</span><span class='line'>#EXTINF:15.050000,
</span><span class='line'>output8.ts
</span><span class='line'>#EXTINF:15.600000,
</span><span class='line'>output9.ts
</span><span class='line'>#EXTINF:15.750000,
</span><span class='line'>output10.ts
</span><span class='line'>#EXTINF:14.000000,
</span><span class='line'>output11.ts
</span><span class='line'>#EXTINF:14.700000,
</span><span class='line'>output12.ts
</span><span class='line'>#EXTINF:15.350000,
</span><span class='line'>output13.ts
</span><span class='line'>#EXTINF:15.000000,
</span><span class='line'>output14.ts
</span><span class='line'>#EXTINF:10.600000,
</span><span class='line'>output15.ts
</span><span class='line'>#EXT-X-ENDLIST</span></code></pre></td></tr></table></div></figure>


<p>搭建hls播放服务</p>

<ul>
<li>参考《做自己的m3u8点播系统使用HTTP Live Streaming(HLS技术）》</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/08/wo-de-railskai-fa-zong-jie/">我的Rails开发总结</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-08T11:43:50+08:00" pubdate data-updated="true">Jan 8<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>[TOC]</p>

<h1>常用Gem列表</h1>

<h3>Rails Auth</h3>

<ul>
<li><p>devise 验证</p></li>
<li><p>cancancan 权限控制</p></li>
</ul>


<h3>Rails Frontend</h3>

<ul>
<li>kaminari 分页控件</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@users = User.all.page(1).per_page(25)
</span><span class='line'>
</span><span class='line'>currentPage: @users.current_page,
</span><span class='line'>totalPages: @users.total_pages,
</span><span class='line'>totalRows: @users.total_count,
</span><span class='line'>hasNextPage: @users.next_page,
</span><span class='line'>hasPreviousPage: @users.prev_page
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>SimpleForm 表单</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>需要执行rails generate simple_form:install --bootstrap</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Popupload 图片上传</li>
<li>carrierwave-upyun 图片上传</li>
<li>mini_magick</li>
<li>carrierwave</li>
<li>carrierwave-meta</li>
<li>rest-client</li>
<li>mime-types</li>
<li>uuidtools</li>
</ul>


<h3>Rails Test Drive</h3>

<ul>
<li>ffaker 快速生成测试数据</li>
</ul>


<h3>Rails Helper</h3>

<ul>
<li>settingslogic</li>
<li>magic_encoding</li>
<li><a href="https://github.com/basecamp/local_time">local_time</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= local_time(comment.created_at) %&gt;</span></code></pre></td></tr></table></div></figure>


<ul>
<li>rails-i18n</li>
<li><a href="https://github.com/Macrow/rails_kindeditor">rails_kindeditor</a></li>
</ul>


<h3>Ruby General</h3>

<ul>
<li><a href="http://pry.github.com/">pry</a></li>
</ul>


<h4>CSS中引用assets中的图片</h4>

<ol>
<li>首先必须是scss或sass</li>
<li>image-url(source) &mdash;> assets/images/sources</li>
</ol>


<h4>Rails中格式化时间</h4>

<ol>
<li>Add gem &lsquo;local_time&rsquo; to your Gemfile.</li>
<li>Run bundle install.</li>
<li>Add //= require local_time to your JavaScript manifest file (usually found at app/assets/javascripts/application.js).</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= h local_time(notice.created_at, '%Y-%M-%d') %&gt;
</span><span class='line'>&lt;%= local_time_ago(time) %&gt;</span></code></pre></td></tr></table></div></figure>


<h4>使用Kindeditor</h4>

<p>1、Gem &lsquo;rails_kindeditor&rsquo;
2、参考 <a href="https://github.com/Macrow/rails_kindeditor">rails_kindeditor</a></p>

<h4>好用的bootstrap插件</h4>

<ol>
<li><a href="http://silviomoreto.github.io/bootstrap-select/">bootstrap-select</a></li>
<li><a href="http://markusslima.github.io/bootstrap-filestyle/">bootstrap-filestyle</a></li>
</ol>


<h3>Jquery插件</h3>

<ol>
<li>全屏遮罩 <a href="http://jquery.malsup.com/block/">blcokUI</a></li>
<li>大图预览 <a href="http://lokeshdhakar.com/projects/lightbox2/">lightbox</a></li>
<li>图片滚动 <a href="http://jquery.malsup.com/cycle2/">cycle2</a></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/30/develop-new-app-step/">开发APP的步骤</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-30T11:00:10+08:00" pubdate data-updated="true">Nov 30<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h5>1、Android签名文件、包名、签名字符串</h5>

<h5>2、IOS签名证书、包名</h5>

<h5>3、应用图标，16，28，32，64，80，100，108，120，512</h5>

<h5>4、应用截图 5张，含首页、关于我们、商品详情、支付</h5>

<h5>5、第三方应用注册申请</h5>

<ul>
<li>微信</li>
<li><p>微博</p>

<p>  微博需要应用简介图片
  微博上线前必须要有应用的下载地址（IOS必须在Appstore上线）</p></li>
<li><p>QQ</p>

<p>  Android 版本申请上线就会发布到 应用宝 市场</p></li>
<li><p>友盟</p></li>
</ul>


<h5>6、微信支付</h5>

<ul>
<li>签约资料准备</li>
<li>商户认证</li>
<li>API安全密钥设置（需要安装操作证书）</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/05/mysql5-dot-5an-zhuang-yu-pei-zhi-fang-fa/">Mysql5.5安装与配置方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-05T15:05:31+08:00" pubdate data-updated="true">Mar 5<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最新的Mysql5.5的源码安装已经不能再用configure的方式了，改成了cmake的编译方式，本文主要用于学习和记录mysql的基本安装方法。</p>

<h2>1、下载源码</h2>

<p>下载源码可以到mysql官网上下载，不过需要注意的是，一定要选择Source Code的方式，下载下来的文件为mysql-5.5.32.tar.gz</p>

<h2>2、编译前的准备工作</h2>

<p>编译前需要为系统安装一些其他工具支持，包括cmake,bison,gcc-c++,ncurses,automake,autoconf等</p>

<p>添加mysql用户和组</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>groupadd mysql
</span><span class='line'>useradd -g mysql mysql -s /sbin/nologin</span></code></pre></td></tr></table></div></figure>


<h2>3、编译</h2>

<p>编译参数可以参考<a href="http://dev.mysql.com/doc/refman/5.5/en/source-configuration-options.html">文档</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cmake -DCMAKE_INSTALL_PREFIX=/usr/local/mysql -DMYSQL_DATADIR=/usr/local/mysql/data -DWITH_INNOBASE_STORAGE_ENGINE=1 -DMYSQL_TCP_PORT=3306 -DMYSQL_UNIX_ADDR=/tmp/mysql.sock -DMYSQL_USER=mysql -DWITH_DEBUG=0 -DDEFAULT_CHAESET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -WITH_EXTRA_CHARSETS:STRING=utf8,gbk
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<h2>4、启动与停止</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chown -R mysql:mysql /usr/local/mysql
</span><span class='line'>scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span></code></pre></td></tr></table></div></figure>


<p>写一个启动停止的脚本</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>mysql_port=3306
</span><span class='line'>mysql_username="root"
</span><span class='line'>mysql_passwd="123456"
</span><span class='line'>mysql_basedir="/usr/local/mysql"
</span><span class='line'>mysql_conf="/usr/local/mysql/conf"
</span><span class='line'>
</span><span class='line'>function_start_mysql()
</span><span class='line'>{
</span><span class='line'>  printf "Starting Mysql...\n"
</span><span class='line'>  /bin/sh ${mysql_basedir}/bin/mysqld_safe --defaults-file=${mysql_conf}f/my.cnf 2&gt;&1 /dev/null &
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>function_stop_mysql()
</span><span class='line'>{
</span><span class='line'>  printf "Stop Mysql...\n"
</span><span class='line'>  ${mysql_basedir}/bin/mysqladmin -u ${mysql_username} -p${mysql_passwd} -S /tmp/mysql.sock shutdown
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>function_restart_mysql()
</span><span class='line'>{
</span><span class='line'>  printf "Restarting Mysql...\n"
</span><span class='line'>  function_stop_mysql
</span><span class='line'>  sleep 5
</span><span class='line'>  function_start_mysql
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>if [ "$1" == "start" ]; then
</span><span class='line'>  function_start_mysql
</span><span class='line'>elif [ "$1" == "stop" ]; then
</span><span class='line'>  function_stop_mysql
</span><span class='line'>elif [ "$1" == "restart" ]; then
</span><span class='line'>  function_restart_mysql
</span><span class='line'>else
</span><span class='line'>  printf "Usage: start|stop|restart\n"
</span><span class='line'>fi
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/05/railszhong-strack-loop-too-deepwen-ti-de-jie-jue/">Rails中strack Loop Too Deep 问题的解决</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-05T10:16:12+08:00" pubdate data-updated="true">Oct 5<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在将一个Rails3.1.2的应用升级到Rails4.0后，突然发现以前运行的好好的程序无法使用了，抛出&#8221;Stack loop too deep&#8221;这个异常。
雅美蝶！！！怎么可能，我这个地方又没使用递归，我瞬间打开IDE，找到了出问题的地方。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  def transcation_in (detail, operator='系统')
</span><span class='line'>    self.money = self.money + detail.money
</span><span class='line'>    detail.account_type = STATE[:in]
</span><span class='line'>    detail.updateby = operator
</span><span class='line'>    detail.save
</span><span class='line'>    self.account_details &lt;&lt; detail
</span><span class='line'>  end</span></code></pre></td></tr></table></div></figure>


<p>如代码所见，逻辑很简单，就是对一个Model对象的简单保存，并加入到关联对象中。这哪里会出现堆栈太深呢。</p>

<p>随后我加入了调试日志</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  def transcation_in (detail, operator='系统')
</span><span class='line'>    puts 'start transcation_in'
</span><span class='line'>    begin
</span><span class='line'>      self.money = self.money + detail.money
</span><span class='line'>      detail.account_type = STATE[:in]
</span><span class='line'>      detail.updateby = operator
</span><span class='line'>      detail.save
</span><span class='line'>      self.account_details &lt;&lt; detail
</span><span class='line'>    rescue Exception =&gt; e
</span><span class='line'>      puts "====#{e}"
</span><span class='line'>    end
</span><span class='line'>    puts 'end transcation_in'
</span><span class='line'>  end</span></code></pre></td></tr></table></div></figure>


<p>查看了日志，异常是在执行“detail.save”这个代码的是报的异常。这明明很正常呢。。。。日怪了。</p>

<p>调试日志看不出东西来，那我就进入了debugger模式，发现执行到这一步时，进入了active_record.transactions.rb这个类里面的save方法，但我没开启事务呢。难道是因为方法名字的问题？？？这有点扯蛋了。。。</p>

<p>我查看了我的Mysql数据表，确实是MyISAM引擎，改成InnoDB试试？尼玛，成功了！！！这里果然用了事务，当数据库表不支持事务时，就抛出了异常！！！</p>

<p>这错误异常信息也太扯蛋了嘛，提示和事务一点关系也没有！</p>

<p>希望这篇文章能为遇到同类问题的人提供解决办法，但问题的根源我还是没找到，为什么会用到事务了呢。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/10/varnish-4-dot-0-an-zhuang-yu-pei-zhi/">Varnish 4.0 安装与配置</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-10T11:44:42+08:00" pubdate data-updated="true">Sep 10<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h5>Varnish简介</h5>

<p>Varnish是一款高性能且开源的反向代理服务器和HTTP加速器，其采用全新的软件体系结构，和现在的硬件体系紧密结合，与传统的Squid相比，varnish具有性能更高，速度更快，管理更加方便等诸多优点。</p>

<h5>安装</h5>

<p>我们这里只将如何以源码在CentOS上安装，其他方式请参考官方文档</p>

<p>1、下载源代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git://git.varnish-cache.org/varnish-cache</span></code></pre></td></tr></table></div></figure>


<p>2、安装必须的依赖包</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install libtool automake autoconf groff libedit-devel ncurses-devel pcre-devel pkgconfig python-docutils</span></code></pre></td></tr></table></div></figure>


<p>3、编译安装</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd varnish-cache
</span><span class='line'>sh autogen.sh
</span><span class='line'>sh configure --prefix=/usr/local/varnish
</span><span class='line'>make
</span><span class='line'>make install</span></code></pre></td></tr></table></div></figure>


<p>4、启动</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./sbin/varnishd -f var/varnish/default.vcl -s malloc,1G -T 127.0.0.1:2000 -a 0.0.0.0:8080
</span><span class='line'>
</span><span class='line'>-f 指定加载配置文件
</span><span class='line'>-s 指定内存库和大小
</span><span class='line'>-T 指定管理端IP和端口
</span><span class='line'>-a 监听的业务IP和端口，这里指监听所有IP</span></code></pre></td></tr></table></div></figure>


<p>5、查看日志</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bin/varnishlog</span></code></pre></td></tr></table></div></figure>


<p>这样就安装好了Varnish，下面就是配置了</p>

<h4>配置</h4>

<p>Varnish的配置是使用它自定义的VCL语法的，在Varnish启动时，会将配置文件编译为C语言。</p>

<ul>
<li><p>内置函数</p>

<p>  vcl_recv：用于接收和处理请求；当请求到达并成功接收后被调用，通过判断请求的数据来决定如何处理请求；</p>

<p>  vcl_pipe：此函数在进入pipe模式时被调用，用于将请求直接传递至后端主机，并将后端响应原样返回客户端；</p>

<p>  vcl_pass：此函数在进入pass模式时被调用，用于将请求直接传递至后端主机，但后端主机的响应并不缓存直接返回客户端；</p>

<p>  vcl_hit：在执行 lookup 指令后，在缓存中找到请求的内容后将自动调用该函数；</p>

<p>  vcl_miss：在执行 lookup 指令后，在缓存中没有找到请求的内容时自动调用该方法，此函数可用于判断是否需要从后端服务器获取内容；</p>

<p>  vcl_hash：在vcl_recv调用后为请求创建一个hash值时，调用此函数；此hash值将作为varnish中搜索缓存对象的key；</p>

<p>  vcl_purge：pruge操作执行后调用此函数，可用于构建一个响应；</p>

<p>  vcl_deliver：将在缓存中找到请求的内容发送给客户端前调用此方法；</p>

<p>  vcl_backend_fetch：向后端主机发送请求前，调用此函数，可修改发往后端的请求；</p>

<p>  vcl_backend_response：获得后端主机的响应后，可调用此函数；</p>

<p>  vcl_backend_error：当从后端主机获取源文件失败时，调用此函数；</p>

<p>  vcl_init：VCL加载时调用此函数，经常用于初始化varnish模块(VMODs)</p>

<p>  vcl_fini：当所有请求都离开当前VCL，且当前VCL被弃用时，调用此函数，经常用于清理varnish模块；</p></li>
<li><p>变量类型详解</p>

<p>  req：The request object，请求到达时可用的变量</p>

<p>  bereq：The backend request object，向后端主机请求时可用的变量</p>

<p>  beresp：The backend response object，从后端主机获取内容时可用的变量</p>

<p>  resp：The HTTP response object，对客户端响应时可用的变量</p>

<p>  obj：存储在内存中时对象属性相关的可用的变量</p></li>
<li><p>示例</p>

<p>  首先VCL文件头必须要写 &lsquo;vcl 4.0&#8217;，强制说明这个配置文件是4.0版本使用的。&#8217;import directors&#8217;是用于代理后端是多机的情况，比如如下配置：</p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vcl 4.0;
</span><span class='line'>import directors;
</span><span class='line'>
</span><span class='line'>backend web1 {
</span><span class='line'>  .host = "localhost";
</span><span class='line'>  .port = "8080";
</span><span class='line'>}
</span><span class='line'>backend web2 {
</span><span class='line'>  .host = "localhost";
</span><span class='line'>  .port = "8080";
</span><span class='line'>}
</span><span class='line'>  #web3是由web1和web2共同组成的，同时web3是使用的轮询的方式来选择是路由到web1还是web2。
</span><span class='line'>sub vcl_init {
</span><span class='line'>    new web3 = directors.round_robin();
</span><span class='line'>    web3.add_backend(web1);
</span><span class='line'>    web3.add_backend(web2);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>sub vcl_recv {
</span><span class='line'>     set req.backend_hint = web3.backend();
</span><span class='line'>     if (req.http.x-forwarded-for) {
</span><span class='line'>       set req.http.X-Forwarded-For =
</span><span class='line'>       req.http.X-Forwarded-For + ", " + client.ip;
</span><span class='line'>     } else {
</span><span class='line'>       set req.http.X-Forwarded-For = client.ip;
</span><span class='line'>     }
</span><span class='line'>     if (req.method != "GET" &&
</span><span class='line'>       req.method != "HEAD" &&
</span><span class='line'>       req.method != "PUT" &&
</span><span class='line'>       req.method != "POST" &&
</span><span class='line'>       req.method != "TRACE" &&
</span><span class='line'>       req.method != "OPTIONS" &&
</span><span class='line'>       req.method != "DELETE") {
</span><span class='line'>         return (pipe);
</span><span class='line'>     }
</span><span class='line'>     if (req.method != "GET" && req.method != "HEAD") {
</span><span class='line'>         return (pass);
</span><span class='line'>     }
</span><span class='line'>     if (req.method == "PURGE") {
</span><span class='line'>        if (client.ip ~ local) {
</span><span class='line'>           return(purge);
</span><span class='line'>        } else {
</span><span class='line'>           return(synth(403, "Access denied."));
</span><span class='line'>        }
</span><span class='line'>     }
</span><span class='line'> }</span></code></pre></td></tr></table></div></figure>


<h4>性能测试</h4>

<ul>
<li>使用Varnish，请求流媒体资源，并发20个</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ab -n 200 -c 20 http://192.168.1.101:8080/data/ring/20090925/47541/1289369.mp3
</span><span class='line'>This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;
</span><span class='line'>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span><span class='line'>Licensed to The Apache Software Foundation, http://www.apache.org/
</span><span class='line'>
</span><span class='line'>Benchmarking 192.168.1.101 (be patient)
</span><span class='line'>Completed 100 requests
</span><span class='line'>Completed 200 requests
</span><span class='line'>Finished 200 requests
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Server Software:        nginx/0.8.46
</span><span class='line'>Server Hostname:        192.168.1.101
</span><span class='line'>Server Port:            8080
</span><span class='line'>
</span><span class='line'>Document Path:          /data/ring/20090925/47541/1289369.mp3
</span><span class='line'>Document Length:        874370 bytes
</span><span class='line'>
</span><span class='line'>Concurrency Level:      20
</span><span class='line'>Time taken for tests:   97.471 seconds
</span><span class='line'>Complete requests:      200
</span><span class='line'>Failed requests:        0
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      174934225 bytes
</span><span class='line'>HTML transferred:       174874000 bytes
</span><span class='line'>Requests per second:    2.05 [#/sec] (mean)
</span><span class='line'>Time per request:       9747.065 [ms] (mean)
</span><span class='line'>Time per request:       487.353 [ms] (mean, across all concurrent requests)
</span><span class='line'>Transfer rate:          1752.67 [Kbytes/sec] received
</span><span class='line'>
</span><span class='line'>Connection Times (ms)
</span><span class='line'>              min  mean[+/-sd] median   max
</span><span class='line'>Connect:       14   67  62.7     47     242
</span><span class='line'>Processing:  3390 9448 2377.2   9474   16366
</span><span class='line'>Waiting:        8   75 108.1     44     753
</span><span class='line'>Total:       3437 9516 2382.5   9576   16421
</span><span class='line'>
</span><span class='line'>Percentage of the requests served within a certain time (ms)
</span><span class='line'>  50%   9576
</span><span class='line'>  66%  10462
</span><span class='line'>  75%  10881
</span><span class='line'>  80%  11306
</span><span class='line'>  90%  12746
</span><span class='line'>  95%  13703
</span><span class='line'>  98%  14877
</span><span class='line'>  99%  15983
</span><span class='line'> 100%  16421 (longest request)</span></code></pre></td></tr></table></div></figure>


<ul>
<li>使用Varnish请求流媒体资源，并发30个</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ab -n 200 -c 30 http://192.168.1.101:8080/data/ring/20090925/47541/1289369.mp3
</span><span class='line'>This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;
</span><span class='line'>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span><span class='line'>Licensed to The Apache Software Foundation, http://www.apache.org/
</span><span class='line'>
</span><span class='line'>Benchmarking 192.168.1.101 (be patient)
</span><span class='line'>Completed 100 requests
</span><span class='line'>Completed 200 requests
</span><span class='line'>Finished 200 requests
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Server Software:        nginx/0.8.46
</span><span class='line'>Server Hostname:        192.168.1.101
</span><span class='line'>Server Port:            8080
</span><span class='line'>
</span><span class='line'>Document Path:          /data/ring/20090925/47541/1289369.mp3
</span><span class='line'>Document Length:        874370 bytes
</span><span class='line'>
</span><span class='line'>Concurrency Level:      30
</span><span class='line'>Time taken for tests:   86.679 seconds
</span><span class='line'>Complete requests:      200
</span><span class='line'>Failed requests:        0
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      174934106 bytes
</span><span class='line'>HTML transferred:       174874000 bytes
</span><span class='line'>Requests per second:    2.31 [#/sec] (mean)
</span><span class='line'>Time per request:       13001.908 [ms] (mean)
</span><span class='line'>Time per request:       433.397 [ms] (mean, across all concurrent requests)
</span><span class='line'>Transfer rate:          1970.87 [Kbytes/sec] received
</span><span class='line'>
</span><span class='line'>Connection Times (ms)
</span><span class='line'>              min  mean[+/-sd] median   max
</span><span class='line'>Connect:        9   83 100.5     45     771
</span><span class='line'>Processing:  6518 12533 3048.6  12224   21697
</span><span class='line'>Waiting:       12   61 100.9     40     979
</span><span class='line'>Total:       6548 12616 3062.2  12429   21723
</span><span class='line'>
</span><span class='line'>Percentage of the requests served within a certain time (ms)
</span><span class='line'>  50%  12429
</span><span class='line'>  66%  13628
</span><span class='line'>  75%  14365
</span><span class='line'>  80%  14881
</span><span class='line'>  90%  17125
</span><span class='line'>  95%  18631
</span><span class='line'>  98%  19900
</span><span class='line'>  99%  20743
</span><span class='line'> 100%  21723 (longest request)</span></code></pre></td></tr></table></div></figure>


<ul>
<li>不使用Varnish请求流媒体，并发20个</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ab -n 200 -c 20 http://192.168.1.101/1289369.mp3
</span><span class='line'>This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;
</span><span class='line'>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span><span class='line'>Licensed to The Apache Software Foundation, http://www.apache.org/
</span><span class='line'>
</span><span class='line'>Benchmarking 192.168.1.101 (be patient)
</span><span class='line'>Completed 100 requests
</span><span class='line'>Completed 200 requests
</span><span class='line'>Finished 200 requests
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Server Software:        nginx/1.4.7
</span><span class='line'>Server Hostname:        192.168.1.101
</span><span class='line'>Server Port:            80
</span><span class='line'>
</span><span class='line'>Document Path:          /1289369.mp3
</span><span class='line'>Document Length:        874370 bytes
</span><span class='line'>
</span><span class='line'>Concurrency Level:      20
</span><span class='line'>Time taken for tests:   95.333 seconds
</span><span class='line'>Complete requests:      200
</span><span class='line'>Failed requests:        0
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      174921600 bytes
</span><span class='line'>HTML transferred:       174874000 bytes
</span><span class='line'>Requests per second:    2.10 [#/sec] (mean)
</span><span class='line'>Time per request:       9533.339 [ms] (mean)
</span><span class='line'>Time per request:       476.667 [ms] (mean, across all concurrent requests)
</span><span class='line'>Transfer rate:          1791.84 [Kbytes/sec] received
</span><span class='line'>
</span><span class='line'>Connection Times (ms)
</span><span class='line'>              min  mean[+/-sd] median   max
</span><span class='line'>Connect:        5   55  55.5     35     538
</span><span class='line'>Processing:  3906 9288 2493.6   9128   17836
</span><span class='line'>Waiting:        2   61  77.9     43     785
</span><span class='line'>Total:       3943 9343 2493.9   9201   17888
</span><span class='line'>
</span><span class='line'>Percentage of the requests served within a certain time (ms)
</span><span class='line'>  50%   9201
</span><span class='line'>  66%  10175
</span><span class='line'>  75%  10619
</span><span class='line'>  80%  10935
</span><span class='line'>  90%  12902
</span><span class='line'>  95%  14188
</span><span class='line'>  98%  16024
</span><span class='line'>  99%  17397
</span><span class='line'> 100%  17888 (longest request)</span></code></pre></td></tr></table></div></figure>


<ul>
<li>不使用Varnish请求流媒体，并发30个</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ab -n 200 -c 30 http://192.168.1.101/1289369.mp3
</span><span class='line'>This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;
</span><span class='line'>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span><span class='line'>Licensed to The Apache Software Foundation, http://www.apache.org/
</span><span class='line'>
</span><span class='line'>Benchmarking 192.168.1.101 (be patient)
</span><span class='line'>Completed 100 requests
</span><span class='line'>Completed 200 requests
</span><span class='line'>Finished 200 requests
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Server Software:        nginx/1.4.7
</span><span class='line'>Server Hostname:        192.168.1.101
</span><span class='line'>Server Port:            80
</span><span class='line'>
</span><span class='line'>Document Path:          /1289369.mp3
</span><span class='line'>Document Length:        874370 bytes
</span><span class='line'>
</span><span class='line'>Concurrency Level:      30
</span><span class='line'>Time taken for tests:   102.131 seconds
</span><span class='line'>Complete requests:      200
</span><span class='line'>Failed requests:        0
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      174921600 bytes
</span><span class='line'>HTML transferred:       174874000 bytes
</span><span class='line'>Requests per second:    1.96 [#/sec] (mean)
</span><span class='line'>Time per request:       15319.686 [ms] (mean)
</span><span class='line'>Time per request:       510.656 [ms] (mean, across all concurrent requests)
</span><span class='line'>Transfer rate:          1672.57 [Kbytes/sec] received
</span><span class='line'>
</span><span class='line'>Connection Times (ms)
</span><span class='line'>              min  mean[+/-sd] median   max
</span><span class='line'>Connect:       18   62  65.2     49     507
</span><span class='line'>Processing:  4651 14863 4008.9  14227   28418
</span><span class='line'>Waiting:        5   83 117.1     48    1091
</span><span class='line'>Total:       4715 14925 4012.8  14322   28482
</span><span class='line'>
</span><span class='line'>Percentage of the requests served within a certain time (ms)
</span><span class='line'>  50%  14322
</span><span class='line'>  66%  16154
</span><span class='line'>  75%  17140
</span><span class='line'>  80%  18276
</span><span class='line'>  90%  20387
</span><span class='line'>  95%  22312
</span><span class='line'>  98%  25391
</span><span class='line'>  99%  26251
</span><span class='line'> 100%  28482 (longest request)</span></code></pre></td></tr></table></div></figure>


<p>可以看出，使用Varnish后，性能有所提升。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/04/deploy-rails-production/">部署rails生产环境</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-04T21:12:01+08:00" pubdate data-updated="true">Aug 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h5>1、添加Gem</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'unicorn'
</span><span class='line'>gem 'execjs'</span></code></pre></td></tr></table></div></figure>


<h5>2、添加unicorn的配置文件</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>touch config/unicorn.conf
</span><span class='line'>vi config/unicorn.conf
</span><span class='line'>rails_env = ENV['RAILS_ENV'] || 'production'
</span><span class='line'>user 'root'
</span><span class='line'>worker_processes 2
</span><span class='line'>preload_app true
</span><span class='line'>timeout 30
</span><span class='line'>listen 3009
</span><span class='line'>working_directory "/www/htdocs/weixin_backend"
</span><span class='line'>pid "/www/htdocs/weixin_backend/unicorn.pid"
</span><span class='line'>stderr_path "/www/htdocs/weixin_backend/log/unicorn.stderr.log"
</span><span class='line'>stdout_path "/www/htdocs/weixin_backend/log/unicorn.stdout.log"</span></code></pre></td></tr></table></div></figure>


<h5>3、添加启动脚本</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unicorn_rails -E production -c config/unicorn.rb -D</span></code></pre></td></tr></table></div></figure>


<h5>4、启动之前需要先执行</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake assets/precompile</span></code></pre></td></tr></table></div></figure>


<h5>5、配置nginx</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location /assets 
</span><span class='line'>{
</span><span class='line'>  root /www/htdocs/weixin_backend/public;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/03/develop-weixin-web-server/">开发微信服务器</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-03T09:40:49+08:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近做了一个微信的商户平台，有些心得，和大家分享一下。</p>

<h3>一、申请帐号</h3>

<p>首先肯定需要注册一个公众平台帐号了，现在注册就能免费成为订阅号，能使用一些基本的接口功能，如：接收消息，发送消息等。而高级的功能，必须是认证的商户，并且缴纳300元/年的认证费（有点坑啊，一年交一次）。具体的接口文档，可以去查看<a href="https://open.weixin.qq.com/cgi-bin/frame?t=resource/res_main_tmpl&lang=zh_CN">微信公众平台开发者文档</a>。</p>

<h3>二、接入</h3>

<h6>1、申请消息接口</h6>

<p>在公众平台网站的高级功能 – 开发模式页，点击“成为开发者”按钮，填写URL和Token，其中URL是开发者用来接收微信服务器数据的接口URL。Token可由开发者任意填写，用作生成签名（该Token会和接口URL中包含的Token进行比对，从而验证安全性）。</p>

<h6>2、验证URL有效性</h6>

<p>微信服务器会对你刚才填的URL做GET请求，并带上下面4个参数</p>

<table>
<thead>
<tr>
<td>参数</td>
<td>描述</td>
</tr>
</thead>
<tbody>
<tr>
<td>signature</td>
<td>微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。</td>
</tr>
<tr>
<td>timestamp</td>
<td>时间戳</td>
</tr>
<tr>
<td>nonce</td>
<td>随机数</td>
</tr>
<tr>
<td>echostr</td>
<td>随机字符串</td>
</tr>
</tbody>
</table>


<p>开发者通过检验signature对请求进行校验（下面有校验方式）。若确认此次GET请求来自微信服务器，请原样返回echostr参数内容，则接入生效，成为开发者成功，否则接入失败。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>加密/校验流程如下：
</span><span class='line'>1. 将token、timestamp、nonce三个参数进行字典序排序
</span><span class='line'>2. 将三个参数字符串拼接成一个字符串进行sha1加密
</span><span class='line'>3. 开发者获得加密后的字符串可与signature对比，标识该请求来源于微信</span></code></pre></td></tr></table></div></figure>


<p>检验signature的Java示例代码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>/**
</span><span class='line'> * 签名校验工具类
</span><span class='line'> * Created by karidyang on 14-2-23.
</span><span class='line'> */
</span><span class='line'>public class SignUtils {
</span><span class='line'>    public static final String TOKEN = "";
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 验证签名
</span><span class='line'>     * @param signature 签名
</span><span class='line'>     * @param timestamp 时间戳
</span><span class='line'>     * @param nonce 随机码
</span><span class='line'>     * @return 校验是否成功
</span><span class='line'>     */
</span><span class='line'>    public static boolean checkSign(String signature, String timestamp, String nonce) {
</span><span class='line'>        if (signature == null) {
</span><span class='line'>            return false;
</span><span class='line'>        }
</span><span class='line'>        try {
</span><span class='line'>            MessageDigest messageDigest = MessageDigest.getInstance("SHA-1");
</span><span class='line'>
</span><span class='line'>            String[] arr = new String[] { TOKEN, timestamp, nonce };
</span><span class='line'>            Arrays.sort(arr);
</span><span class='line'>            String str = StringUtils.join(arr,"");
</span><span class='line'>            byte[] digest = messageDigest.digest(str.getBytes());
</span><span class='line'>            String tmpStr = byteToStr(digest);
</span><span class='line'>            return tmpStr != null && tmpStr.equals(signature.toUpperCase());
</span><span class='line'>
</span><span class='line'>        } catch (NoSuchAlgorithmException e) {
</span><span class='line'>            e.printStackTrace();
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        return false;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 将字节数组转换为十六进制字符串
</span><span class='line'>     *
</span><span class='line'>     * @param byteArray
</span><span class='line'>     * @return
</span><span class='line'>     */
</span><span class='line'>    private static String byteToStr(byte[] byteArray) {
</span><span class='line'>        String strDigest = "";
</span><span class='line'>        for (int i = 0; i &lt; byteArray.length; i++) {
</span><span class='line'>            strDigest += byteToHexStr(byteArray[i]);
</span><span class='line'>        }
</span><span class='line'>        return strDigest;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 将字节转换为十六进制字符串
</span><span class='line'>     *
</span><span class='line'>     * @param mByte
</span><span class='line'>     * @return
</span><span class='line'>     */
</span><span class='line'>    private static String byteToHexStr(byte mByte) {
</span><span class='line'>        char[] Digit = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F' };
</span><span class='line'>        char[] tempArr = new char[2];
</span><span class='line'>        tempArr[0] = Digit[(mByte &gt;&gt;&gt; 4) & 0X0F];
</span><span class='line'>        tempArr[1] = Digit[mByte & 0X0F];
</span><span class='line'>
</span><span class='line'>        String s = new String(tempArr);
</span><span class='line'>        return s;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>3、成为开发者</h6>

<p>验证URL有效性成功后即接入生效，成为开发者。如果公众号类型为服务号（订阅号只能使用普通消息接口），可以在公众平台网站中申请认证，认证成功的服务号将获得众多接口权限，以满足开发者需求。</p>

<p>此后用户每次向公众号发送消息、或者产生自定义菜单点击事件时，响应URL将得到推送。</p>

<p>公众号调用各接口时，一般会获得正确的结果，具体结果可见对应接口的说明。返回错误时，可根据返回码来查询错误原因。全局返回码说明</p>

<p>用户向公众号发送消息时，公众号方收到的消息发送者是一个OpenID，是使用用户微信号加密后的结果，每个用户对每个公众号有一个唯一的OpenID。</p>

<p>此外请注意，微信公众号接口只支持80接口。</p>

<h3>三、设置菜单</h3>

<p>微信设置菜单的方式比较简单，就是POST一个JSON格式的菜单数据到微信服务器就行了，只是不同的菜单按钮对应不同的功能，比如可点击的，或者执行某项请求的，或者是跳转的。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/11/use-nginx/">使用Nginx的一些心得体会</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-11T18:19:10+08:00" pubdate data-updated="true">Mar 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>1、安装Nginx</h4>

<p>在linux上安装nginx，可以使用源码安装，也可以使用包安装器安装，如 apt-get, yum等，使用包安装器安装比较简单，所以，这里我们介绍源码安装。</p>

<p>首先需要下载源码包，可以在这里下载<a href="http://nginx.org/download/nginx-1.4.2.tar.gz">nginx</a></p>

<p>下载之后就需要安装。</p>

<pre><code>tar -zxvf nginx-1.4.2.tar.gz
cd nginx-1.4.2
./configure --prefix=/usr/local/nginx_8080 --user=www --group=www  --with-http_stub_status_module --without-http_fastcgi_module --without-http_autoindex_module --without-http_ssi_module --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --without-http_uwsgi_module --without-http_scgi_module  --without-http_memcached_module
make
make  install
</code></pre>

<p>说明：</p>

<p>&mdash;prefix : 安装目录<br/>
&mdash;user: linux中的用户<br/>
&mdash;group: linux中的用户组<br/>
&mdash;with-http_stub_status_module : 安装http_status模块<br/>
&mdash;without-http_fastcgi_module : 如不需要后端接入php、asp等可以不安装fastcgi模块<br/>
&mdash;without-http_autoindex_module : 不安装文件目录索引模块<br/>
&mdash;without-http_ssi_module : 不安装https模块<br/>
&mdash;without-mail_pop3_module &mdash;without-mail_imap_module &mdash;without-mail_smtp_module : 不安装mail模块<br/>
&mdash;without-http_memcached_module : 不安装memcached模块<br/></p>

<p>编译以后，会在安装目录下找到conf目录，我们后面的主要配置就是编辑这个目录下的nginx.conf文件。</p>

<h4>2、配置</h4>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/02/26/learn-docker/">学习Docker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/22/da-jian-shi-pin-bo-fang-fu-wu/">搭建视频播放服务</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/08/wo-de-railskai-fa-zong-jie/">我的Rails开发总结</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/30/develop-new-app-step/">开发APP的步骤</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/05/mysql5-dot-5an-zhuang-yu-pei-zhi-fang-fa/">Mysql5.5安装与配置方法</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>About Me</h1>
  <p>
    Java开发者，Rails开发者。<br/><br/>

    Java开发工程师，现就职于 <a href="http://www.gwsoft.com.cn">四川长城软件科技股份有限公司</a> 
  </p>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - karidyang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>， 感谢 <a href="http://gitcafe.com">GitCafe</a> 为本站提供存储空间</span>
</p>

</footer>
  











</body>
</html>
