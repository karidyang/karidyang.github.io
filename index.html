<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>逆水前行</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="逆水前行">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="逆水前行">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="karidyang">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">逆水前行</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2021学习计划" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/22/2021%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/" class="article-date">
  <time datetime="2021-04-22T08:27:09.000Z" itemprop="datePublished">2021-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/22/2021%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/">2021学习计划</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h2><ul>
<li>技术管理<ul>
<li>不断温习极客时间课程《技术管理实战36讲》</li>
</ul>
</li>
<li>OKR<ul>
<li>学习 《黄勇的OKR实战笔记》</li>
</ul>
</li>
</ul>
<h2 id="技术"><a href="#技术" class="headerlink" title="技术"></a>技术</h2><ul>
<li>Spring<ul>
<li>《小马哥讲Spring核心编程思想》</li>
<li>《小马哥讲Spring AOP编程思想》</li>
<li>《小马哥Java训练营》</li>
<li>《玩转Spring全家桶》</li>
</ul>
</li>
<li>ES<ul>
<li>《Elasticsearch核心技术与实战》</li>
</ul>
</li>
<li>K8S<ul>
<li>《深入剖析Kubernetes》</li>
<li><a target="_blank" rel="noopener" href="https://www.toutiao.com/i6935430385463542309/?wid=1619060049943">2021年Kubernetes架构师攻略</a></li>
</ul>
</li>
<li>架构<ul>
<li>《从0开始学架构》</li>
<li>《周志明的软件架构课》</li>
<li>《许式伟的架构课》</li>
<li>《十年架构感悟》</li>
<li>《DDD实战课》</li>
</ul>
</li>
<li>存储<ul>
<li>《后端存储实战课》</li>
<li>《消息队列高手课》</li>
<li>《MySQL实战45讲》</li>
<li>《Redis核心技术与实战》</li>
<li>《Kafka核心技术与实战》</li>
<li>《ZooKeeper实战与源码剖析》</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/22/2021%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/" data-id="cknsom0ci000l5e5yd93i5t8d" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-2016-02-26-learn-docker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/26/2016-02-26-learn-docker/" class="article-date">
  <time datetime="2016-02-26T05:28:55.000Z" itemprop="datePublished">2016-02-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/26/2016-02-26-learn-docker/">学习Docker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <ol>
<li><p>Docker是什么<br> Docker是一个容器</p>
</li>
<li><p>Docker基本命令</p>
<ul>
<li>创建Ubuntu系统的容器 <code>docker run -it ubuntu:14.04 /bin/bash</code></li>
<li>查看当前所有容器 <code>docker ps -a </code></li>
<li>删除容器 <code>docker rm &#123;容器ID/名称&#125;</code></li>
<li>发布容器 <code>docker commit </code></li>
<li>绑定随机端口 <code>docker run -d -P --name &#123;容器名&#125; ubuntu:14.04 /bin/bash</code></li>
<li>绑定指定端口 <code>docker run -d -p &#123;本机ip&#125;:&#123;本机端口&#125;:&#123;容器端口&#125; --name &#123;容器名&#125; ubuntu:14.04 /bin/bash</code></li>
<li>挂载本机目录 <code>docker run -d -v `pwd`:/webapp ubuntu:14.04 /bin/bash</code></li>
</ul>
</li>
<li><p>Dockerfile</p>
<p> 使用Dockerfile可以比较方便的统一完成容器的搭建、配置工作<br> 一个比较完整的文件示例如下</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#Version 1.0.1</span><br><span class="line">From ubuntu:14.04	#基本镜像</span><br><span class="line"></span><br><span class="line">MAINTAINER xxx &quot;xxx@xxx.xx&quot; #镜像作者信息</span><br><span class="line"></span><br><span class="line">#设置root用户为后续命令的执行者</span><br><span class="line">USER root</span><br><span class="line"></span><br><span class="line">#执行操作</span><br><span class="line">RUN apt-get update</span><br><span class="line">RUN apt-get install -y nginx</span><br><span class="line"></span><br><span class="line">#使用&amp;&amp;拼接命令</span><br><span class="line">RUN touch test.txt &amp;&amp; echo &#39;test&#39; &gt;&gt; test.txt</span><br><span class="line"></span><br><span class="line">#对外暴露端口</span><br><span class="line">EXPOSE 80 8080 9000</span><br><span class="line"></span><br><span class="line">#添加文件</span><br><span class="line">ADD abc.txt &#x2F;opt</span><br><span class="line">#添加网络文件</span><br><span class="line">ADD http:&#x2F;&#x2F;xxx &#x2F;opt</span><br><span class="line"></span><br><span class="line">#设置环境变量</span><br><span class="line">ENV WEB_PORT&#x3D;80</span><br><span class="line"></span><br><span class="line">#设置工作目录</span><br><span class="line">WORKDIR &#x2F;opt&#x2F;</span><br><span class="line"></span><br><span class="line">#设置卷</span><br><span class="line">VOLUME [&quot;&#x2F;data&quot;, &quot;&#x2F;var&#x2F;www&quot;]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2016/02/26/2016-02-26-learn-docker/" data-id="cknsom0ch000j5e5y72gs94ao" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2016-01-22-da-jian-shi-pin-bo-fang-fu-wu" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/22/2016-01-22-da-jian-shi-pin-bo-fang-fu-wu/" class="article-date">
  <time datetime="2016-01-22T09:01:46.000Z" itemprop="datePublished">2016-01-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/22/2016-01-22-da-jian-shi-pin-bo-fang-fu-wu/">搭建视频播放服务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h4 id="安装必备软件"><a href="#安装必备软件" class="headerlink" title="安装必备软件"></a>安装必备软件</h4><ul>
<li>libx264<br>得到安装源代码 git clone git://git.videolan.org/x264.git<br>编译 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --disable-yasm --enable-shared --enable-static</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></li>
</ul>
<p>把so包增加到系统中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;&#39; &gt;&gt; &#x2F;etc&#x2F;ld.so.conf</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure>

<ul>
<li>ffmpeg<br>下载 <a target="_blank" rel="noopener" href="http://ffmpeg.org/releases/ffmpeg-2.7.2.tar.bz2">http://ffmpeg.org/releases/ffmpeg-2.7.2.tar.bz2</a><br>编译 ./configure –disable-yasm</li>
</ul>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>把mp4文件分割为多个ts文件和m3u8</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 2001045000007.mp4 -c:v libx264 -c:a aac -strict -2 -f hls -hls_time 15 -hls_list_size 0 output.m3u8</span><br></pre></td></tr></table></figure>
<p>-hls_time n: 设置每片的长度，默认值为2。单位为秒</p>
<p>-hls_list_size n:设置播放列表保存的最多条目，设置为0会保存有所片信息，默认值为5</p>
<p>-hls_wrap n:设置多少片之后开始覆盖，如果设置为0则不会覆盖，默认值为0.这个选项能够避免在磁盘上存储过多的片，而且能够限制写入磁盘的最多的片的数量</p>
<p>-hls_start_number n:设置播放列表中sequence number的值为number，默认值为0</p>
<p>注意：播放列表的sequence number 对每个segment来说都必须是唯一的，而且它不能和片的文件名（当使用wrap选项时，文件名有可能会重复使用）混淆</p>
<p>生成的m3u8文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat output.m3u8</span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:22</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:21.050000,</span><br><span class="line">output0.ts</span><br><span class="line">#EXTINF:11.000000,</span><br><span class="line">output1.ts</span><br><span class="line">#EXTINF:13.500000,</span><br><span class="line">output2.ts</span><br><span class="line">#EXTINF:14.500000,</span><br><span class="line">output3.ts</span><br><span class="line">#EXTINF:16.500000,</span><br><span class="line">output4.ts</span><br><span class="line">#EXTINF:19.600000,</span><br><span class="line">output5.ts</span><br><span class="line">#EXTINF:8.900000,</span><br><span class="line">output6.ts</span><br><span class="line">#EXTINF:14.950000,</span><br><span class="line">output7.ts</span><br><span class="line">#EXTINF:15.050000,</span><br><span class="line">output8.ts</span><br><span class="line">#EXTINF:15.600000,</span><br><span class="line">output9.ts</span><br><span class="line">#EXTINF:15.750000,</span><br><span class="line">output10.ts</span><br><span class="line">#EXTINF:14.000000,</span><br><span class="line">output11.ts</span><br><span class="line">#EXTINF:14.700000,</span><br><span class="line">output12.ts</span><br><span class="line">#EXTINF:15.350000,</span><br><span class="line">output13.ts</span><br><span class="line">#EXTINF:15.000000,</span><br><span class="line">output14.ts</span><br><span class="line">#EXTINF:10.600000,</span><br><span class="line">output15.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>
<p>搭建hls播放服务</p>
<ul>
<li>参考《做自己的m3u8点播系统使用HTTP Live Streaming(HLS技术）》</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2016/01/22/2016-01-22-da-jian-shi-pin-bo-fang-fu-wu/" data-id="cknsom0cg000h5e5y2pvwdqwv" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-2016-01-08-wo-de-railskai-fa-zong-jie" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/08/2016-01-08-wo-de-railskai-fa-zong-jie/" class="article-date">
  <time datetime="2016-01-08T03:43:50.000Z" itemprop="datePublished">2016-01-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/08/2016-01-08-wo-de-railskai-fa-zong-jie/">我的Rails开发总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>[TOC]</p>
<h1 id="常用Gem列表"><a href="#常用Gem列表" class="headerlink" title="常用Gem列表"></a>常用Gem列表</h1><h3 id="Rails-Auth"><a href="#Rails-Auth" class="headerlink" title="Rails Auth"></a>Rails Auth</h3><ul>
<li><p>devise 验证</p>
</li>
<li><p>cancancan 权限控制</p>
</li>
</ul>
<h3 id="Rails-Frontend"><a href="#Rails-Frontend" class="headerlink" title="Rails Frontend"></a>Rails Frontend</h3><ul>
<li>kaminari 分页控件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@users &#x3D; User.all.page(1).per_page(25)</span><br><span class="line"></span><br><span class="line">currentPage: @users.current_page,</span><br><span class="line">totalPages: @users.total_pages,</span><br><span class="line">totalRows: @users.total_count,</span><br><span class="line">hasNextPage: @users.next_page,</span><br><span class="line">hasPreviousPage: @users.prev_page</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>SimpleForm 表单</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">需要执行rails generate simple_form:install --bootstrap</span><br></pre></td></tr></table></figure>

<ul>
<li>Popupload 图片上传</li>
<li>carrierwave-upyun 图片上传</li>
<li>mini_magick</li>
<li>carrierwave</li>
<li>carrierwave-meta</li>
<li>rest-client</li>
<li>mime-types</li>
<li>uuidtools</li>
</ul>
<h3 id="Rails-Test-Drive"><a href="#Rails-Test-Drive" class="headerlink" title="Rails Test Drive"></a>Rails Test Drive</h3><ul>
<li>ffaker 快速生成测试数据</li>
</ul>
<h3 id="Rails-Helper"><a href="#Rails-Helper" class="headerlink" title="Rails Helper"></a>Rails Helper</h3><ul>
<li>settingslogic</li>
<li>magic_encoding</li>
<li><a target="_blank" rel="noopener" href="https://github.com/basecamp/local_time">local_time</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%&#x3D; local_time(comment.created_at) %&gt;</span><br></pre></td></tr></table></figure>


<ul>
<li>rails-i18n</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Macrow/rails_kindeditor">rails_kindeditor</a></li>
</ul>
<h3 id="Ruby-General"><a href="#Ruby-General" class="headerlink" title="Ruby General"></a>Ruby General</h3><ul>
<li><a target="_blank" rel="noopener" href="http://pry.github.com/">pry</a></li>
</ul>
<h4 id="CSS中引用assets中的图片"><a href="#CSS中引用assets中的图片" class="headerlink" title="CSS中引用assets中的图片"></a>CSS中引用assets中的图片</h4><ol>
<li>首先必须是scss或sass</li>
<li>image-url(source) –&gt; assets/images/sources</li>
</ol>
<h4 id="Rails中格式化时间"><a href="#Rails中格式化时间" class="headerlink" title="Rails中格式化时间"></a>Rails中格式化时间</h4><ol>
<li>Add gem ‘local_time’ to your Gemfile.</li>
<li>Run bundle install.</li>
<li>Add //= require local_time to your JavaScript manifest file (usually found at app/assets/javascripts/application.js).</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%&#x3D; h local_time(notice.created_at, &#39;%Y-%M-%d&#39;) %&gt;</span><br><span class="line">&lt;%&#x3D; local_time_ago(time) %&gt;</span><br></pre></td></tr></table></figure>

<h4 id="使用Kindeditor"><a href="#使用Kindeditor" class="headerlink" title="使用Kindeditor"></a>使用Kindeditor</h4><p>1、Gem ‘rails_kindeditor’<br>2、参考 <a target="_blank" rel="noopener" href="https://github.com/Macrow/rails_kindeditor">rails_kindeditor</a></p>
<h4 id="好用的bootstrap插件"><a href="#好用的bootstrap插件" class="headerlink" title="好用的bootstrap插件"></a>好用的bootstrap插件</h4><ol>
<li><a target="_blank" rel="noopener" href="http://silviomoreto.github.io/bootstrap-select/">bootstrap-select</a></li>
<li><a target="_blank" rel="noopener" href="http://markusslima.github.io/bootstrap-filestyle/">bootstrap-filestyle</a></li>
</ol>
<h3 id="Jquery插件"><a href="#Jquery插件" class="headerlink" title="Jquery插件"></a>Jquery插件</h3><ol>
<li>全屏遮罩 <a target="_blank" rel="noopener" href="http://jquery.malsup.com/block/">blcokUI</a></li>
<li>大图预览 <a target="_blank" rel="noopener" href="http://lokeshdhakar.com/projects/lightbox2/">lightbox</a></li>
<li>图片滚动 <a target="_blank" rel="noopener" href="http://jquery.malsup.com/cycle2/">cycle2</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2016/01/08/2016-01-08-wo-de-railskai-fa-zong-jie/" data-id="cknsom0cf000f5e5y5mvyaw58" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Rails-%E5%BC%80%E5%8F%91/" rel="tag">Rails, 开发</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2015-11-30-develop-new-app-step" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/30/2015-11-30-develop-new-app-step/" class="article-date">
  <time datetime="2015-11-30T03:00:10.000Z" itemprop="datePublished">2015-11-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/30/2015-11-30-develop-new-app-step/">开发APP的步骤</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h5 id="1、Android签名文件、包名、签名字符串"><a href="#1、Android签名文件、包名、签名字符串" class="headerlink" title="1、Android签名文件、包名、签名字符串"></a>1、Android签名文件、包名、签名字符串</h5><h5 id="2、IOS签名证书、包名"><a href="#2、IOS签名证书、包名" class="headerlink" title="2、IOS签名证书、包名"></a>2、IOS签名证书、包名</h5><h5 id="3、应用图标，16，28，32，64，80，100，108，120，512"><a href="#3、应用图标，16，28，32，64，80，100，108，120，512" class="headerlink" title="3、应用图标，16，28，32，64，80，100，108，120，512"></a>3、应用图标，16，28，32，64，80，100，108，120，512</h5><h5 id="4、应用截图-5张，含首页、关于我们、商品详情、支付"><a href="#4、应用截图-5张，含首页、关于我们、商品详情、支付" class="headerlink" title="4、应用截图 5张，含首页、关于我们、商品详情、支付"></a>4、应用截图 5张，含首页、关于我们、商品详情、支付</h5><h5 id="5、第三方应用注册申请"><a href="#5、第三方应用注册申请" class="headerlink" title="5、第三方应用注册申请"></a>5、第三方应用注册申请</h5><ul>
<li><p>微信</p>
</li>
<li><p>微博</p>
<p>  微博需要应用简介图片<br>  微博上线前必须要有应用的下载地址（IOS必须在Appstore上线）</p>
</li>
<li><p>QQ</p>
<p>  Android 版本申请上线就会发布到 应用宝 市场</p>
</li>
<li><p>友盟</p>
</li>
</ul>
<h5 id="6、微信支付"><a href="#6、微信支付" class="headerlink" title="6、微信支付"></a>6、微信支付</h5><ul>
<li>签约资料准备</li>
<li>商户认证</li>
<li>API安全密钥设置（需要安装操作证书）</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2015/11/30/2015-11-30-develop-new-app-step/" data-id="cknsom0ce000d5e5yheg19mnw" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2015-03-05-mysql5-dot-5an-zhuang-yu-pei-zhi-fang-fa" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/05/2015-03-05-mysql5-dot-5an-zhuang-yu-pei-zhi-fang-fa/" class="article-date">
  <time datetime="2015-03-05T07:05:31.000Z" itemprop="datePublished">2015-03-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/05/2015-03-05-mysql5-dot-5an-zhuang-yu-pei-zhi-fang-fa/">Mysql5.5安装与配置方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>最新的Mysql5.5的源码安装已经不能再用configure的方式了，改成了cmake的编译方式，本文主要用于学习和记录mysql的基本安装方法。</p>
<h2 id="1、下载源码"><a href="#1、下载源码" class="headerlink" title="1、下载源码"></a>1、下载源码</h2><p>下载源码可以到mysql官网上下载，不过需要注意的是，一定要选择Source Code的方式，下载下来的文件为mysql-5.5.32.tar.gz</p>
<h2 id="2、编译前的准备工作"><a href="#2、编译前的准备工作" class="headerlink" title="2、编译前的准备工作"></a>2、编译前的准备工作</h2><p>编译前需要为系统安装一些其他工具支持，包括cmake,bison,gcc-c++,ncurses,automake,autoconf等</p>
<p>添加mysql用户和组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd mysql</span><br><span class="line">useradd -g mysql mysql -s &#x2F;sbin&#x2F;nologin</span><br></pre></td></tr></table></figure>

<h2 id="3、编译"><a href="#3、编译" class="headerlink" title="3、编译"></a>3、编译</h2><p>编译参数可以参考<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.5/en/source-configuration-options.html">文档</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_INSTALL_PREFIX&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql -DMYSQL_DATADIR&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;data -DWITH_INNOBASE_STORAGE_ENGINE&#x3D;1 -DMYSQL_TCP_PORT&#x3D;3306 -DMYSQL_UNIX_ADDR&#x3D;&#x2F;tmp&#x2F;mysql.sock -DMYSQL_USER&#x3D;mysql -DWITH_DEBUG&#x3D;0 -DDEFAULT_CHAESET&#x3D;utf8 -DDEFAULT_COLLATION&#x3D;utf8_general_ci -WITH_EXTRA_CHARSETS:STRING&#x3D;utf8,gbk</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="4、启动与停止"><a href="#4、启动与停止" class="headerlink" title="4、启动与停止"></a>4、启动与停止</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql:mysql &#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">scripts&#x2F;mysql_install_db --user&#x3D;mysql --basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql --datadir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;data</span><br></pre></td></tr></table></figure>

<p>写一个启动停止的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">mysql_port&#x3D;3306</span><br><span class="line">mysql_username&#x3D;&quot;root&quot;</span><br><span class="line">mysql_passwd&#x3D;&quot;123456&quot;</span><br><span class="line">mysql_basedir&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;mysql&quot;</span><br><span class="line">mysql_conf&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;conf&quot;</span><br><span class="line"></span><br><span class="line">function_start_mysql()</span><br><span class="line">&#123;</span><br><span class="line">	printf &quot;Starting Mysql...\n&quot;</span><br><span class="line">	&#x2F;bin&#x2F;sh $&#123;mysql_basedir&#125;&#x2F;bin&#x2F;mysqld_safe --defaults-file&#x3D;$&#123;mysql_conf&#125;f&#x2F;my.cnf 2&gt;&amp;1 &#x2F;dev&#x2F;null &amp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_stop_mysql()</span><br><span class="line">&#123;</span><br><span class="line">	printf &quot;Stop Mysql...\n&quot;</span><br><span class="line">	$&#123;mysql_basedir&#125;&#x2F;bin&#x2F;mysqladmin -u $&#123;mysql_username&#125; -p$&#123;mysql_passwd&#125; -S &#x2F;tmp&#x2F;mysql.sock shutdown</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_restart_mysql()</span><br><span class="line">&#123;</span><br><span class="line">	printf &quot;Restarting Mysql...\n&quot;</span><br><span class="line">	function_stop_mysql</span><br><span class="line">	sleep 5</span><br><span class="line">	function_start_mysql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ &quot;$1&quot; &#x3D;&#x3D; &quot;start&quot; ]; then</span><br><span class="line">	function_start_mysql</span><br><span class="line">elif [ &quot;$1&quot; &#x3D;&#x3D; &quot;stop&quot; ]; then</span><br><span class="line">	function_stop_mysql</span><br><span class="line">elif [ &quot;$1&quot; &#x3D;&#x3D; &quot;restart&quot; ]; then</span><br><span class="line">	function_restart_mysql</span><br><span class="line">else</span><br><span class="line">	printf &quot;Usage: start|stop|restart\n&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2015/03/05/2015-03-05-mysql5-dot-5an-zhuang-yu-pei-zhi-fang-fa/" data-id="cknsom0cc000b5e5y7q7n6g94" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2014-10-05-railszhong-strack-loop-too-deepwen-ti-de-jie-jue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/10/05/2014-10-05-railszhong-strack-loop-too-deepwen-ti-de-jie-jue/" class="article-date">
  <time datetime="2014-10-05T02:16:12.000Z" itemprop="datePublished">2014-10-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/10/05/2014-10-05-railszhong-strack-loop-too-deepwen-ti-de-jie-jue/">rails中strack loop too deep 问题的解决</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>在将一个Rails3.1.2的应用升级到Rails4.0后，突然发现以前运行的好好的程序无法使用了，抛出”Stack loop too deep”这个异常。<br>雅美蝶！！！怎么可能，我这个地方又没使用递归，我瞬间打开IDE，找到了出问题的地方。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def transcation_in (detail, operator&#x3D;&#39;系统&#39;)</span><br><span class="line">  self.money &#x3D; self.money + detail.money</span><br><span class="line">  detail.account_type &#x3D; STATE[:in]</span><br><span class="line">  detail.updateby &#x3D; operator</span><br><span class="line">  detail.save</span><br><span class="line">  self.account_details &lt;&lt; detail</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>如代码所见，逻辑很简单，就是对一个Model对象的简单保存，并加入到关联对象中。这哪里会出现堆栈太深呢。</p>
<p>随后我加入了调试日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def transcation_in (detail, operator&#x3D;&#39;系统&#39;)</span><br><span class="line">  puts &#39;start transcation_in&#39;</span><br><span class="line">  begin</span><br><span class="line">    self.money &#x3D; self.money + detail.money</span><br><span class="line">    detail.account_type &#x3D; STATE[:in]</span><br><span class="line">    detail.updateby &#x3D; operator</span><br><span class="line">    detail.save</span><br><span class="line">    self.account_details &lt;&lt; detail</span><br><span class="line">  rescue Exception &#x3D;&gt; e</span><br><span class="line">    puts &quot;&#x3D;&#x3D;&#x3D;&#x3D;#&#123;e&#125;&quot;</span><br><span class="line">  end</span><br><span class="line">  puts &#39;end transcation_in&#39;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>查看了日志，异常是在执行“detail.save”这个代码的是报的异常。这明明很正常呢。。。。日怪了。</p>
<p>调试日志看不出东西来，那我就进入了debugger模式，发现执行到这一步时，进入了active_record.transactions.rb这个类里面的save方法，但我没开启事务呢。难道是因为方法名字的问题？？？这有点扯蛋了。。。</p>
<p>我查看了我的Mysql数据表，确实是MyISAM引擎，改成InnoDB试试？尼玛，成功了！！！这里果然用了事务，当数据库表不支持事务时，就抛出了异常！！！</p>
<p>这错误异常信息也太扯蛋了嘛，提示和事务一点关系也没有！</p>
<p>希望这篇文章能为遇到同类问题的人提供解决办法，但问题的根源我还是没找到，为什么会用到事务了呢。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2014/10/05/2014-10-05-railszhong-strack-loop-too-deepwen-ti-de-jie-jue/" data-id="cknsom0cb00095e5yc2iyhinb" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/" rel="tag">rails</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2014-09-10-varnish-4-dot-0-an-zhuang-yu-pei-zhi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/09/10/2014-09-10-varnish-4-dot-0-an-zhuang-yu-pei-zhi/" class="article-date">
  <time datetime="2014-09-10T03:44:42.000Z" itemprop="datePublished">2014-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/10/2014-09-10-varnish-4-dot-0-an-zhuang-yu-pei-zhi/">varnish 4.0 安装与配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Varnish简介"><a href="#Varnish简介" class="headerlink" title="Varnish简介"></a>Varnish简介</h2><p>Varnish是一款高性能且开源的反向代理服务器和HTTP加速器，其采用全新的软件体系结构，和现在的硬件体系紧密结合，与传统的Squid相比，varnish具有性能更高，速度更快，管理更加方便等诸多优点。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>我们这里只将如何以源码在CentOS上安装，其他方式请参考官方文档</p>
<p>1、下载源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git:&#x2F;&#x2F;git.varnish-cache.org&#x2F;varnish-cache</span><br></pre></td></tr></table></figure>

<p>2、安装必须的依赖包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install libtool automake autoconf groff libedit-devel ncurses-devel pcre-devel pkgconfig python-docutils</span><br></pre></td></tr></table></figure>

<p>3、编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd varnish-cache</span><br><span class="line">sh autogen.sh</span><br><span class="line">sh configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;varnish</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>4、启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;sbin&#x2F;varnishd -f var&#x2F;varnish&#x2F;default.vcl -s malloc,1G -T 127.0.0.1:2000 -a 0.0.0.0:8080</span><br><span class="line"></span><br><span class="line">-f 指定加载配置文件</span><br><span class="line">-s 指定内存库和大小</span><br><span class="line">-T 指定管理端IP和端口</span><br><span class="line">-a 监听的业务IP和端口，这里指监听所有IP</span><br></pre></td></tr></table></figure>

<p>5、查看日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin&#x2F;varnishlog</span><br></pre></td></tr></table></figure>

<p>这样就安装好了Varnish，下面就是配置了</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>Varnish的配置是使用它自定义的VCL语法的，在Varnish启动时，会将配置文件编译为C语言。</p>
<ul>
<li><p>内置函数</p>
<p>  vcl_recv：用于接收和处理请求；当请求到达并成功接收后被调用，通过判断请求的数据来决定如何处理请求；</p>
<p>  vcl_pipe：此函数在进入pipe模式时被调用，用于将请求直接传递至后端主机，并将后端响应原样返回客户端；</p>
<p>  vcl_pass：此函数在进入pass模式时被调用，用于将请求直接传递至后端主机，但后端主机的响应并不缓存直接返回客户端；</p>
<p>  vcl_hit：在执行 lookup 指令后，在缓存中找到请求的内容后将自动调用该函数；</p>
<p>  vcl_miss：在执行 lookup 指令后，在缓存中没有找到请求的内容时自动调用该方法，此函数可用于判断是否需要从后端服务器获取内容；</p>
<p>  vcl_hash：在vcl_recv调用后为请求创建一个hash值时，调用此函数；此hash值将作为varnish中搜索缓存对象的key；</p>
<p>  vcl_purge：pruge操作执行后调用此函数，可用于构建一个响应；</p>
<p>  vcl_deliver：将在缓存中找到请求的内容发送给客户端前调用此方法；</p>
<p>  vcl_backend_fetch：向后端主机发送请求前，调用此函数，可修改发往后端的请求；</p>
<p>  vcl_backend_response：获得后端主机的响应后，可调用此函数；</p>
<p>  vcl_backend_error：当从后端主机获取源文件失败时，调用此函数；</p>
<p>  vcl_init：VCL加载时调用此函数，经常用于初始化varnish模块(VMODs)</p>
<p>  vcl_fini：当所有请求都离开当前VCL，且当前VCL被弃用时，调用此函数，经常用于清理varnish模块；</p>
</li>
</ul>
<ul>
<li><p>变量类型详解</p>
<p>  req：The request object，请求到达时可用的变量</p>
<p>  bereq：The backend request object，向后端主机请求时可用的变量</p>
<p>  beresp：The backend response object，从后端主机获取内容时可用的变量</p>
<p>  resp：The HTTP response object，对客户端响应时可用的变量</p>
<p>  obj：存储在内存中时对象属性相关的可用的变量</p>
</li>
<li><p>示例</p>
<p>  首先VCL文件头必须要写 ‘vcl 4.0’，强制说明这个配置文件是4.0版本使用的。’import directors’是用于代理后端是多机的情况，比如如下配置：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">vcl 4.0;</span><br><span class="line">import directors;</span><br><span class="line"></span><br><span class="line">backend web1 &#123;</span><br><span class="line">	.host &#x3D; &quot;localhost&quot;;</span><br><span class="line">	.port &#x3D; &quot;8080&quot;;</span><br><span class="line">&#125;</span><br><span class="line">backend web2 &#123;</span><br><span class="line">	.host &#x3D; &quot;localhost&quot;;</span><br><span class="line">	.port &#x3D; &quot;8080&quot;;</span><br><span class="line">&#125;</span><br><span class="line">	#web3是由web1和web2共同组成的，同时web3是使用的轮询的方式来选择是路由到web1还是web2。</span><br><span class="line">sub vcl_init &#123;</span><br><span class="line">    new web3 &#x3D; directors.round_robin();</span><br><span class="line">    web3.add_backend(web1);</span><br><span class="line">    web3.add_backend(web2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line">     set req.backend_hint &#x3D; web3.backend();</span><br><span class="line">     if (req.http.x-forwarded-for) &#123;</span><br><span class="line">       set req.http.X-Forwarded-For &#x3D;</span><br><span class="line">       req.http.X-Forwarded-For + &quot;, &quot; + client.ip;</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">       set req.http.X-Forwarded-For &#x3D; client.ip;</span><br><span class="line">     &#125;</span><br><span class="line">     if (req.method !&#x3D; &quot;GET&quot; &amp;&amp;</span><br><span class="line">       req.method !&#x3D; &quot;HEAD&quot; &amp;&amp;</span><br><span class="line">       req.method !&#x3D; &quot;PUT&quot; &amp;&amp;</span><br><span class="line">       req.method !&#x3D; &quot;POST&quot; &amp;&amp;</span><br><span class="line">       req.method !&#x3D; &quot;TRACE&quot; &amp;&amp;</span><br><span class="line">       req.method !&#x3D; &quot;OPTIONS&quot; &amp;&amp;</span><br><span class="line">       req.method !&#x3D; &quot;DELETE&quot;) &#123;</span><br><span class="line">         return (pipe);</span><br><span class="line">     &#125;</span><br><span class="line">     if (req.method !&#x3D; &quot;GET&quot; &amp;&amp; req.method !&#x3D; &quot;HEAD&quot;) &#123;</span><br><span class="line">         return (pass);</span><br><span class="line">     &#125;</span><br><span class="line">     if (req.method &#x3D;&#x3D; &quot;PURGE&quot;) &#123;</span><br><span class="line">        if (client.ip ~ local) &#123;</span><br><span class="line">           return(purge);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">           return(synth(403, &quot;Access denied.&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><ul>
<li>使用Varnish，请求流媒体资源，并发20个</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">ab -n 200 -c 20 http:&#x2F;&#x2F;192.168.1.101:8080&#x2F;data&#x2F;ring&#x2F;20090925&#x2F;47541&#x2F;1289369.mp3</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:&#x2F;&#x2F;www.zeustech.net&#x2F;</span><br><span class="line">Licensed to The Apache Software Foundation, http:&#x2F;&#x2F;www.apache.org&#x2F;</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.1.101 (be patient)</span><br><span class="line">Completed 100 requests</span><br><span class="line">Completed 200 requests</span><br><span class="line">Finished 200 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx&#x2F;0.8.46</span><br><span class="line">Server Hostname:        192.168.1.101</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          &#x2F;data&#x2F;ring&#x2F;20090925&#x2F;47541&#x2F;1289369.mp3</span><br><span class="line">Document Length:        874370 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      20</span><br><span class="line">Time taken for tests:   97.471 seconds</span><br><span class="line">Complete requests:      200</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      174934225 bytes</span><br><span class="line">HTML transferred:       174874000 bytes</span><br><span class="line">Requests per second:    2.05 [#&#x2F;sec] (mean)</span><br><span class="line">Time per request:       9747.065 [ms] (mean)</span><br><span class="line">Time per request:       487.353 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1752.67 [Kbytes&#x2F;sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+&#x2F;-sd] median   max</span><br><span class="line">Connect:       14   67  62.7     47     242</span><br><span class="line">Processing:  3390 9448 2377.2   9474   16366</span><br><span class="line">Waiting:        8   75 108.1     44     753</span><br><span class="line">Total:       3437 9516 2382.5   9576   16421</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%   9576</span><br><span class="line">  66%  10462</span><br><span class="line">  75%  10881</span><br><span class="line">  80%  11306</span><br><span class="line">  90%  12746</span><br><span class="line">  95%  13703</span><br><span class="line">  98%  14877</span><br><span class="line">  99%  15983</span><br><span class="line"> 100%  16421 (longest request)</span><br></pre></td></tr></table></figure>

<ul>
<li>使用Varnish请求流媒体资源，并发30个</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">ab -n 200 -c 30 http:&#x2F;&#x2F;192.168.1.101:8080&#x2F;data&#x2F;ring&#x2F;20090925&#x2F;47541&#x2F;1289369.mp3</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:&#x2F;&#x2F;www.zeustech.net&#x2F;</span><br><span class="line">Licensed to The Apache Software Foundation, http:&#x2F;&#x2F;www.apache.org&#x2F;</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.1.101 (be patient)</span><br><span class="line">Completed 100 requests</span><br><span class="line">Completed 200 requests</span><br><span class="line">Finished 200 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx&#x2F;0.8.46</span><br><span class="line">Server Hostname:        192.168.1.101</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          &#x2F;data&#x2F;ring&#x2F;20090925&#x2F;47541&#x2F;1289369.mp3</span><br><span class="line">Document Length:        874370 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   86.679 seconds</span><br><span class="line">Complete requests:      200</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      174934106 bytes</span><br><span class="line">HTML transferred:       174874000 bytes</span><br><span class="line">Requests per second:    2.31 [#&#x2F;sec] (mean)</span><br><span class="line">Time per request:       13001.908 [ms] (mean)</span><br><span class="line">Time per request:       433.397 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1970.87 [Kbytes&#x2F;sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+&#x2F;-sd] median   max</span><br><span class="line">Connect:        9   83 100.5     45     771</span><br><span class="line">Processing:  6518 12533 3048.6  12224   21697</span><br><span class="line">Waiting:       12   61 100.9     40     979</span><br><span class="line">Total:       6548 12616 3062.2  12429   21723</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%  12429</span><br><span class="line">  66%  13628</span><br><span class="line">  75%  14365</span><br><span class="line">  80%  14881</span><br><span class="line">  90%  17125</span><br><span class="line">  95%  18631</span><br><span class="line">  98%  19900</span><br><span class="line">  99%  20743</span><br><span class="line"> 100%  21723 (longest request)</span><br></pre></td></tr></table></figure>

<ul>
<li>不使用Varnish请求流媒体，并发20个</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">ab -n 200 -c 20 http:&#x2F;&#x2F;192.168.1.101&#x2F;1289369.mp3</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:&#x2F;&#x2F;www.zeustech.net&#x2F;</span><br><span class="line">Licensed to The Apache Software Foundation, http:&#x2F;&#x2F;www.apache.org&#x2F;</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.1.101 (be patient)</span><br><span class="line">Completed 100 requests</span><br><span class="line">Completed 200 requests</span><br><span class="line">Finished 200 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx&#x2F;1.4.7</span><br><span class="line">Server Hostname:        192.168.1.101</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          &#x2F;1289369.mp3</span><br><span class="line">Document Length:        874370 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      20</span><br><span class="line">Time taken for tests:   95.333 seconds</span><br><span class="line">Complete requests:      200</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      174921600 bytes</span><br><span class="line">HTML transferred:       174874000 bytes</span><br><span class="line">Requests per second:    2.10 [#&#x2F;sec] (mean)</span><br><span class="line">Time per request:       9533.339 [ms] (mean)</span><br><span class="line">Time per request:       476.667 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1791.84 [Kbytes&#x2F;sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+&#x2F;-sd] median   max</span><br><span class="line">Connect:        5   55  55.5     35     538</span><br><span class="line">Processing:  3906 9288 2493.6   9128   17836</span><br><span class="line">Waiting:        2   61  77.9     43     785</span><br><span class="line">Total:       3943 9343 2493.9   9201   17888</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%   9201</span><br><span class="line">  66%  10175</span><br><span class="line">  75%  10619</span><br><span class="line">  80%  10935</span><br><span class="line">  90%  12902</span><br><span class="line">  95%  14188</span><br><span class="line">  98%  16024</span><br><span class="line">  99%  17397</span><br><span class="line"> 100%  17888 (longest request)</span><br></pre></td></tr></table></figure>


<ul>
<li>不使用Varnish请求流媒体，并发30个</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">ab -n 200 -c 30 http:&#x2F;&#x2F;192.168.1.101&#x2F;1289369.mp3</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:&#x2F;&#x2F;www.zeustech.net&#x2F;</span><br><span class="line">Licensed to The Apache Software Foundation, http:&#x2F;&#x2F;www.apache.org&#x2F;</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.1.101 (be patient)</span><br><span class="line">Completed 100 requests</span><br><span class="line">Completed 200 requests</span><br><span class="line">Finished 200 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx&#x2F;1.4.7</span><br><span class="line">Server Hostname:        192.168.1.101</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          &#x2F;1289369.mp3</span><br><span class="line">Document Length:        874370 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   102.131 seconds</span><br><span class="line">Complete requests:      200</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      174921600 bytes</span><br><span class="line">HTML transferred:       174874000 bytes</span><br><span class="line">Requests per second:    1.96 [#&#x2F;sec] (mean)</span><br><span class="line">Time per request:       15319.686 [ms] (mean)</span><br><span class="line">Time per request:       510.656 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1672.57 [Kbytes&#x2F;sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+&#x2F;-sd] median   max</span><br><span class="line">Connect:       18   62  65.2     49     507</span><br><span class="line">Processing:  4651 14863 4008.9  14227   28418</span><br><span class="line">Waiting:        5   83 117.1     48    1091</span><br><span class="line">Total:       4715 14925 4012.8  14322   28482</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%  14322</span><br><span class="line">  66%  16154</span><br><span class="line">  75%  17140</span><br><span class="line">  80%  18276</span><br><span class="line">  90%  20387</span><br><span class="line">  95%  22312</span><br><span class="line">  98%  25391</span><br><span class="line">  99%  26251</span><br><span class="line"> 100%  28482 (longest request)</span><br></pre></td></tr></table></figure>

<p>可以看出，使用Varnish后，性能有所提升。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2014/09/10/2014-09-10-varnish-4-dot-0-an-zhuang-yu-pei-zhi/" data-id="cknsom0c800055e5yggvz9g5m" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/varnish/" rel="tag">varnish</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2014-08-04-deploy-rails-production" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/08/04/2014-08-04-deploy-rails-production/" class="article-date">
  <time datetime="2014-08-04T13:12:01.000Z" itemprop="datePublished">2014-08-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/08/04/2014-08-04-deploy-rails-production/">部署rails生产环境</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <ul>
<li>1、添加Gem</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem &#39;unicorn&#39;</span><br><span class="line">gem &#39;execjs&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>2、添加unicorn的配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">touch config&#x2F;unicorn.conf</span><br><span class="line">vi config&#x2F;unicorn.conf</span><br><span class="line">rails_env &#x3D; ENV[&#39;RAILS_ENV&#39;] || &#39;production&#39;</span><br><span class="line">user &#39;root&#39;</span><br><span class="line">worker_processes 2</span><br><span class="line">preload_app true</span><br><span class="line">timeout 30</span><br><span class="line">listen 3009</span><br><span class="line">working_directory &quot;&#x2F;www&#x2F;htdocs&#x2F;weixin_backend&quot;</span><br><span class="line">pid &quot;&#x2F;www&#x2F;htdocs&#x2F;weixin_backend&#x2F;unicorn.pid&quot;</span><br><span class="line">stderr_path &quot;&#x2F;www&#x2F;htdocs&#x2F;weixin_backend&#x2F;log&#x2F;unicorn.stderr.log&quot;</span><br><span class="line">stdout_path &quot;&#x2F;www&#x2F;htdocs&#x2F;weixin_backend&#x2F;log&#x2F;unicorn.stdout.log&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>3、添加启动脚本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unicorn_rails -E production -c config&#x2F;unicorn.rb -D</span><br></pre></td></tr></table></figure>

<ul>
<li>4、启动之前需要先执行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake assets&#x2F;precompile</span><br></pre></td></tr></table></figure>

<ul>
<li>5、配置nginx</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;assets </span><br><span class="line">&#123;</span><br><span class="line">	root &#x2F;www&#x2F;htdocs&#x2F;weixin_backend&#x2F;public;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2014/08/04/2014-08-04-deploy-rails-production/" data-id="cknsom0ca00085e5y98d3530c" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/" rel="tag">rails</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2014-06-03-develop-weixin-web-server" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/06/03/2014-06-03-develop-weixin-web-server/" class="article-date">
  <time datetime="2014-06-03T01:40:49.000Z" itemprop="datePublished">2014-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/06/03/2014-06-03-develop-weixin-web-server/">开发微信服务器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>最近做了一个微信的商户平台，有些心得，和大家分享一下。</p>
<h3 id="一、申请帐号"><a href="#一、申请帐号" class="headerlink" title="一、申请帐号"></a>一、申请帐号</h3><p>首先肯定需要注册一个公众平台帐号了，现在注册就能免费成为订阅号，能使用一些基本的接口功能，如：接收消息，发送消息等。而高级的功能，必须是认证的商户，并且缴纳300元/年的认证费（有点坑啊，一年交一次）。具体的接口文档，可以去查看<a target="_blank" rel="noopener" href="https://open.weixin.qq.com/cgi-bin/frame?t=resource/res_main_tmpl&lang=zh_CN">微信公众平台开发者文档</a>。</p>
<h3 id="二、接入"><a href="#二、接入" class="headerlink" title="二、接入"></a>二、接入</h3><h6 id="1、申请消息接口"><a href="#1、申请消息接口" class="headerlink" title="1、申请消息接口"></a>1、申请消息接口</h6><p>在公众平台网站的高级功能 – 开发模式页，点击“成为开发者”按钮，填写URL和Token，其中URL是开发者用来接收微信服务器数据的接口URL。Token可由开发者任意填写，用作生成签名（该Token会和接口URL中包含的Token进行比对，从而验证安全性）。 </p>
<h6 id="2、验证URL有效性"><a href="#2、验证URL有效性" class="headerlink" title="2、验证URL有效性"></a>2、验证URL有效性</h6><p>微信服务器会对你刚才填的URL做GET请求，并带上下面4个参数</p>
<table>
<thead>
<tr>
<td>参数</td>
<td>描述</td>
</tr>
</thead>
<tbody>
<tr>
<td>signature</td>
<td>微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。</td>
</tr>
<tr>
<td>timestamp</td>
<td>时间戳</td>
</tr>
<tr>
<td>nonce</td>
<td>随机数</td>
</tr>
<tr>
<td>echostr</td>
<td>随机字符串</td>
</tr>
</tbody>
</table>

<p>开发者通过检验signature对请求进行校验（下面有校验方式）。若确认此次GET请求来自微信服务器，请原样返回echostr参数内容，则接入生效，成为开发者成功，否则接入失败。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">加密&#x2F;校验流程如下：</span><br><span class="line">1. 将token、timestamp、nonce三个参数进行字典序排序</span><br><span class="line">2. 将三个参数字符串拼接成一个字符串进行sha1加密</span><br><span class="line">3. 开发者获得加密后的字符串可与signature对比，标识该请求来源于微信</span><br></pre></td></tr></table></figure>

<p>检验signature的Java示例代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 签名校验工具类</span><br><span class="line"> * Created by karidyang on 14-2-23.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class SignUtils &#123;</span><br><span class="line">    public static final String TOKEN &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 验证签名</span><br><span class="line">     * @param signature 签名</span><br><span class="line">     * @param timestamp 时间戳</span><br><span class="line">     * @param nonce 随机码</span><br><span class="line">     * @return 校验是否成功</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static boolean checkSign(String signature, String timestamp, String nonce) &#123;</span><br><span class="line">        if (signature &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            MessageDigest messageDigest &#x3D; MessageDigest.getInstance(&quot;SHA-1&quot;);</span><br><span class="line"></span><br><span class="line">            String[] arr &#x3D; new String[] &#123; TOKEN, timestamp, nonce &#125;;</span><br><span class="line">            Arrays.sort(arr);</span><br><span class="line">            String str &#x3D; StringUtils.join(arr,&quot;&quot;);</span><br><span class="line">            byte[] digest &#x3D; messageDigest.digest(str.getBytes());</span><br><span class="line">            String tmpStr &#x3D; byteToStr(digest);</span><br><span class="line">            return tmpStr !&#x3D; null &amp;&amp; tmpStr.equals(signature.toUpperCase());</span><br><span class="line"></span><br><span class="line">        &#125; catch (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 将字节数组转换为十六进制字符串</span><br><span class="line">     *</span><br><span class="line">     * @param byteArray</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String byteToStr(byte[] byteArray) &#123;</span><br><span class="line">        String strDigest &#x3D; &quot;&quot;;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; byteArray.length; i++) &#123;</span><br><span class="line">            strDigest +&#x3D; byteToHexStr(byteArray[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return strDigest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 将字节转换为十六进制字符串</span><br><span class="line">     *</span><br><span class="line">     * @param mByte</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String byteToHexStr(byte mByte) &#123;</span><br><span class="line">        char[] Digit &#x3D; &#123; &#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39; &#125;;</span><br><span class="line">        char[] tempArr &#x3D; new char[2];</span><br><span class="line">        tempArr[0] &#x3D; Digit[(mByte &gt;&gt;&gt; 4) &amp; 0X0F];</span><br><span class="line">        tempArr[1] &#x3D; Digit[mByte &amp; 0X0F];</span><br><span class="line"></span><br><span class="line">        String s &#x3D; new String(tempArr);</span><br><span class="line">        return s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="3、成为开发者"><a href="#3、成为开发者" class="headerlink" title="3、成为开发者"></a>3、成为开发者</h6><p>验证URL有效性成功后即接入生效，成为开发者。如果公众号类型为服务号（订阅号只能使用普通消息接口），可以在公众平台网站中申请认证，认证成功的服务号将获得众多接口权限，以满足开发者需求。</p>
<p>此后用户每次向公众号发送消息、或者产生自定义菜单点击事件时，响应URL将得到推送。</p>
<p>公众号调用各接口时，一般会获得正确的结果，具体结果可见对应接口的说明。返回错误时，可根据返回码来查询错误原因。全局返回码说明</p>
<p>用户向公众号发送消息时，公众号方收到的消息发送者是一个OpenID，是使用用户微信号加密后的结果，每个用户对每个公众号有一个唯一的OpenID。</p>
<p>此外请注意，微信公众号接口只支持80接口。</p>
<h3 id="三、设置菜单"><a href="#三、设置菜单" class="headerlink" title="三、设置菜单"></a>三、设置菜单</h3><p>微信设置菜单的方式比较简单，就是POST一个JSON格式的菜单数据到微信服务器就行了，只是不同的菜单按钮对应不同的功能，比如可点击的，或者执行某项请求的，或者是跳转的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2014/06/03/2014-06-03-develop-weixin-web-server/" data-id="cknsom0c700045e5ya8o8bvge" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java-weixin/" rel="tag">java, weixin</a></li></ul>

    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页&amp;raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    
  <div class="widget-wrap">
     
        <h3 class="follow-title ">Follow me</h3>
     
    <div class="widget follow">
      
              <a class="github" aria-hidden="true" href="https://github.com/karidyang" target="_blank" title="Github"></a>
      
      
            <a class="weibo" aria-hidden="true"  href="http://weibo.com/karidyang" target="_blank" title="微博"></a>
      
      
      
            <a class="email" aria-hidden="true"  href="mailto:karidyang@gmail.com" target="_blank" title="邮箱"></a>
      
    </div>
  </div>


  
    
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title tagcloud">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Docker/" style="font-size: 14px;">Docker</a> <a href="/tags/Jetty/" style="font-size: 14px;">Jetty</a> <a href="/tags/Rails-%E5%BC%80%E5%8F%91/" style="font-size: 14px;">Rails, 开发</a> <a href="/tags/java/" style="font-size: 14px;">java</a> <a href="/tags/java-weixin/" style="font-size: 14px;">java, weixin</a> <a href="/tags/mysql/" style="font-size: 14px;">mysql</a> <a href="/tags/nginx/" style="font-size: 14px;">nginx</a> <a href="/tags/rails/" style="font-size: 25px;">rails</a> <a href="/tags/varnish/" style="font-size: 14px;">varnish</a> <a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 14px;">开发</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/22/2021%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/">2021学习计划</a>
          </li>
        
          <li>
            <a href="/2016/02/26/2016-02-26-learn-docker/">学习Docker</a>
          </li>
        
          <li>
            <a href="/2016/01/22/2016-01-22-da-jian-shi-pin-bo-fang-fu-wu/">搭建视频播放服务</a>
          </li>
        
          <li>
            <a href="/2016/01/08/2016-01-08-wo-de-railskai-fa-zong-jie/">我的Rails开发总结</a>
          </li>
        
          <li>
            <a href="/2015/11/30/2015-11-30-develop-new-app-step/">开发APP的步骤</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title archive">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">十月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">一月 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
    
<div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
        <ul>
            
            <li>
                <a target="_blank" rel="noopener" href="https://huangbaihua.gitee.io">BAIHUA&#39;s blog</a>
            </li>
            
        </ul>
    </div>
</div>

  
    <!--微信公众号二维码-->

  <div class="widget-wrap">
    <h3 class="follow-title ">WeChat</h3>
    <div class="widget wechat-widget">
        <img src="http://blog-img.taoguli.com/img/qrcode_for_gh_fb1e6b53a000_258.jpg" alt="扫码关注" width="250"/>
    </div>
  </div>


  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2021 karidyang&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;karidyang@gmail.com
    </div>
  </div>
</footer>
 
<script src="/jquery/jquery.min.js"></script>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
      

  
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "e2fb4051c49842688ce669e634bc983f",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
    

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


 
<script src="/js/is.js"></script>



  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/elevator.js"></script>

  </div>
</body>
</html>